import{s as k,u as O,_ as A,c as y,o as f,a as t,b as S,w as z,F as T,r as N,n as F,t as x,d as U,e as $,f as B,g as H,h as G,i as D,j as X,k as Y,l as J}from"./main-Bwn9CEnY.js";import{i as V,m as P,M as Q,g as K,e as Z,a as ee}from"./Message-d-xXRxxh.js";import{m as q}from"./material_config-CxyZ_E5r.js";const te=(w,o,i=0)=>{const e=w-o;let b;e<-3?b=0:e>6?b=2:b=(e+3)/4.5;const d=o-i;let c;return d<-3?c=0:d>3?c=1:c=(d+3)/6,Math.min(Math.max(.5*b*c,0),1)},se=(w,o,i)=>{const e=Object.keys(V.equipment_levels),b=Math.random();let d=0;for(const c of e){let n=V.equipment_levels[c].chance;if(i<.7){if(["epic","legendary","mythic"].includes(c)&&Math.random()>.5)return"rare"}else if(i<.8){if(["legendary","mythic"].includes(c)&&Math.random()>.5)return"epic"}else if(i<.9&&c==="mythic"&&Math.random()>.5)return"legendary";if(d+=n,b<=d)return c}return"common"},ne=(w,o,i)=>{const e=V.equipment_position[w],d=V.equipment_levels[i].name,c=o.reduce((n,a)=>a.materialLevel>n.materialLevel?a:n);let v="未知";for(const n in q.material_types){const a=q.material_types[n].materials;if(a[c.materialId]){v=a[c.materialId].name;break}}return`${d}${v}${e.name}`},ae=(w,o,i,e)=>{for(const b in q.material_types){const d=q.material_types[b],c=d.materials;if(c[w]){const v=c[w],n={},l=V.equipment_position[i].stat_multipliers||{};for(const r in d.base_stats){let h=Math.ceil(d.base_stats[r]*v.multiplier*v.level*o*2*(l[r]||1));if(!["crit_rate","crit_resist","hit_rate","dodge_rate"].includes(r)){const M=V.equipment_levels[e].multiplier;h=Math.ceil(h*M)}n[r]=h}return n}}return null},W=async w=>{const o=[...k.player.materials];w.forEach(i=>{const e=o.indexOf(i);e!==-1&&o.splice(e,1)}),await O({materials:o})},oe=async({materials:w,forgerLevel:o,toolLevel:i,equipmentType:e})=>{if(!w||w.length===0||w.length>5)return{success:!1,message:"材料数量必须在1-5之间"};if(!V.equipment_position[e])return{success:!1,message:"无效的装备类型"};const d=w.map(l=>{let r=0;for(const M in q.material_types){const _=q.material_types[M].materials;if(_[l]){r=_[l].level;break}}const h=te(o,i,r);return{materialId:l,success:Math.random()<h,successRate:h,materialLevel:r}}).filter(l=>l.success);if(d.length===0)return await W(w),{success:!1,message:"锻造失败，所有材料都未能成功融合"};const c=d.reduce((l,r)=>r.materialLevel>l.materialLevel?r:l),v=se(o,i,c.successRate),n={type:e,position:e,level:v,combat_info:{}},a=new Set;for(const l in q.material_types){const r=q.material_types[l].base_stats;for(const h in r)a.add(h)}return a.forEach(l=>{n.combat_info[l]=0}),d.forEach(l=>{const r=ae(l.materialId,l.successRate,e,v);r&&Object.keys(r).forEach(h=>{n.combat_info[h]+=r[h]})}),n.name=ne(e,d,v),k.player.unequipped.push(n),await W(w),{success:!0,message:`锻造成功！${d.length}个材料成功融合`,equipment:n}},ie={name:"ForgeView",emits:["close"],setup(w,{emit:o}){const i=$([]),e=$(""),b=$(null),d=$(!1),c=V.equipment_position,v=B(()=>k.player.materials);H(v,()=>{i.value=[],e.value=""});const n=_=>{for(const g in q.material_types){const I=q.material_types[g].materials;if(I[_])return I[_].name}return _},a=(_,g)=>{i.value.findIndex(E=>E.index===g)!==-1?l(g):i.value.length<5&&i.value.push({material:_,index:g})},l=_=>{i.value=i.value.filter(g=>g.index!==_)};return{availableMaterials:v,selectedMaterials:i,selectedType:e,equipmentTypes:c,forgeResult:b,getMaterialName:n,toggleMaterial:a,removeMaterial:l,selectEquipmentType:_=>{e.value=_},startForge:async()=>{if(!(!e.value||i.value.length===0||i.value.length>5||d.value)){d.value=!0;try{const _=k.player.forgerLevel||1,g=k.player.toolLevel||1,I=await oe({materials:i.value.map(E=>E.material),forgerLevel:_,toolLevel:g,equipmentType:e.value});b.value=I,i.value=[],e.value=""}finally{d.value=!1}}},handleCloseClick:_=>{const g=_.currentTarget.getBoundingClientRect();_.clientY-g.top<100&&o("close")}}}},le={class:"forge-view-container"},ce={class:"forge-view"},re={class:"forge-header"},ue={class:"equipment-type-selection"},de={class:"equipment-types"},ve=["onClick"],pe={class:"materials-selection"},me={class:"materials-list"},fe=["onClick"],_e={key:0,class:"selected-materials"},he={class:"selected-list"},ge=["onClick"],ye=["disabled"],be={key:0,class:"equipment-stats"};function Ce(w,o,i,e,b,d){return f(),y("div",le,[t("div",ce,[t("div",re,[o[2]||(o[2]=t("div",{class:"forge-title"},"装备锻造",-1)),t("button",{class:"close-button",onClick:o[0]||(o[0]=z((...c)=>e.handleCloseClick&&e.handleCloseClick(...c),["stop"]))},"×")]),t("div",ue,[o[3]||(o[3]=t("div",{class:"section-title"},"选择装备类型",-1)),t("div",de,[(f(!0),y(T,null,N(e.equipmentTypes,(c,v)=>(f(),y("div",{key:v,class:F(["equipment-type-item",{selected:e.selectedType===v}]),onClick:n=>e.selectEquipmentType(v)},x(c.name),11,ve))),128))])]),t("div",pe,[o[4]||(o[4]=t("div",{class:"section-title"},"选择材料 (1-5件)",-1)),t("div",me,[(f(!0),y(T,null,N(e.availableMaterials,(c,v)=>(f(),y("div",{key:v,class:F(["material-item",{selected:e.selectedMaterials.some(n=>n.index===v)}]),onClick:n=>e.toggleMaterial(c,v)},x(e.getMaterialName(c)),11,fe))),128))])]),e.selectedMaterials.length>0?(f(),y("div",_e,[o[5]||(o[5]=t("div",{class:"section-title"},"已选材料",-1)),t("div",he,[(f(!0),y(T,null,N(e.selectedMaterials,(c,v)=>(f(),y("div",{key:v,class:"selected-item"},[U(x(e.getMaterialName(c.material))+" ",1),t("button",{onClick:n=>e.removeMaterial(c.index)},"移除",8,ge)]))),128))])])):S("",!0),t("button",{class:"forge-button",onClick:o[1]||(o[1]=(...c)=>e.startForge&&e.startForge(...c)),disabled:e.selectedMaterials.length===0||e.selectedMaterials.length>5}," 开始锻造 ",8,ye),e.forgeResult?(f(),y("div",{key:1,class:F(["forge-result",e.forgeResult.success?"success":"fail"])},[o[6]||(o[6]=t("div",{class:"section-title"},"锻造结果",-1)),t("p",null,x(e.forgeResult.message),1),e.forgeResult.equipment?(f(),y("div",be,[t("p",null,"获得装备："+x(e.forgeResult.equipment.name),1)])):S("",!0)],2)):S("",!0)])])}const we=A(ie,[["render",Ce],["__scopeId","data-v-143880b7"]]),ke={potion_001:{id:"potion_001",name:"小型生命药水",description:"恢复少量生命值的药水",effect:{type:"hp",value:50}},potion_002:{id:"potion_002",name:"中型生命药水",description:"恢复中等生命值的药水",effect:{type:"hp",value:100}},potion_003:{id:"potion_003",name:"大型生命药水",description:"恢复大量生命值的药水",effect:{type:"hp",value:200}}},Me={potions:ke},$e={class:"shop-view-container"},xe={class:"shop-content"},Ie={class:"shop-section"},Le={class:"shop-grid"},qe=["onClick"],Ee={class:"item-name"},Re={class:"item-price"},Se={class:"inventory-section"},Te={class:"inventory-grid"},Ne=["onClick"],Ve={class:"item-name"},je={class:"item-price"},Be={key:0,class:"item-count"},Fe={__name:"ShopView",emits:["close"],setup(w,{emit:o}){const i=o,e=B(()=>P[k.currentMapId]),b=B(()=>{var s;return(s=e.value)==null?void 0:s.locations[k.currentLocationId]}),d=B(()=>{var m,u,L;return(((L=(u=(m=b.value)==null?void 0:m.npc)==null?void 0:u.shop)==null?void 0:L.items)||[]).map(R=>{const j=Me.potions[R.id];return{...R,name:j.name,description:j.description,effect:j.effect}})}),c=B(()=>{const m=(k.player.materials||[]).reduce((u,L)=>(u[L]=(u[L]||0)+1,u),{});return Object.entries(m).map(([u,L])=>{for(const R of Object.values(q.material_types)){const j=R.materials[u];if(j)return{id:u,name:j.name,level:j.level,type:R.name,count:L}}return null}).filter(Boolean)}),v=s=>100*s.level,n=$(!1),a=$(""),l=$("info"),r=$(!1),h=$("确定"),M=$(()=>{}),_=s=>{a.value=`${s.name}<br>${s.description}<br>价格: ${s.price} 金币`,l.value="info",n.value=!0,r.value=!0,h.value="购买",M.value=()=>I(s)},g=s=>{const m=v(s);a.value=`${s.name}<br>类型: ${s.type}<br>等级: ${s.level}<br>售价: ${m} 金币`,l.value="info",n.value=!0,r.value=!0,h.value="出售",M.value=()=>E(s)},I=async s=>{if(k.player.gold<s.price){D(()=>{a.value="金币不足！",l.value="error",r.value=!1,n.value=!0});return}const m={...k.player};m.gold-=s.price,m.potions.push(s),await O(m),D(()=>{a.value="购买成功！",l.value="success",r.value=!1,n.value=!0})},E=async s=>{const m=v(s),u={...k.player};u.gold+=m;const L=u.materials.findIndex(R=>R===s.id);L!==-1?(u.materials.splice(L,1),await O(u),a.value=`出售成功！获得 ${m} 金币`,l.value="success"):(a.value="出售失败！",l.value="error"),r.value=!1},C=()=>{M.value()},p=()=>{i("close")};return(s,m)=>(f(),y("div",$e,[t("div",{class:"shop-header"},[m[1]||(m[1]=t("div",{class:"title"},"商店",-1)),t("div",{class:"close-button",onClick:p},"×")]),t("div",xe,[t("div",Ie,[t("div",Le,[(f(!0),y(T,null,N(d.value,u=>(f(),y("div",{key:u.id,class:"shop-item",onClick:L=>_(u)},[t("div",Ee,x(u.name),1),t("div",Re,x(u.price)+" 金币",1)],8,qe))),128))])]),t("div",Se,[t("div",Te,[(f(!0),y(T,null,N(c.value,u=>(f(),y("div",{key:u.id,class:"inventory-item",onClick:L=>g(u)},[t("div",Ve,x(u.name),1),t("div",je,x(v(u))+" 金币",1),u.count>1?(f(),y("div",Be,"x"+x(u.count),1)):S("",!0)],8,Ne))),128))])])]),G(Q,{visible:n.value,"onUpdate:visible":m[0]||(m[0]=u=>n.value=u),content:a.value,type:l.value,"show-button":r.value,"button-text":h.value,onAction:C},null,8,["visible","content","type","show-button","button-text"])]))}},Pe=A(Fe,[["__scopeId","data-v-fe2b6861"]]),Ae={class:"location-container"},Oe={class:"content-wrapper"},De={class:"location-header"},Ye={class:"location-title"},He={class:"combat-log"},Ke={class:"combat-log-content"},We={class:"tab-container"},Xe={key:0,class:"enemies-list"},ze={class:"enemies-list-content"},Ue=["onClick","disabled"],Ge={key:1,class:"npcs-list"},Je={class:"npcs-list-content"},Qe=["onClick"],Ze={key:0,class:"enter-button"},et={__name:"LocationView",emits:["close"],setup(w,{emit:o}){const i=$("enemies");K();const e=B(()=>P[k.currentMapId].locations[k.currentLocationId]),b=$([]),d=$(!1),c=B(()=>(P[k.currentMapId].locations[k.currentLocationId],Object.entries(k.enemyStatus).filter(([C,p])=>p.locationId===k.currentLocationId).map(([C,p])=>{const s=p.enemyId,m=Z.creatures[s];return{instanceId:C,name:m.name,desc:m.desc,hp:p.hp}}))),v=o;X(()=>{b.value.push({id:Date.now(),message:`你进入了${e.value.name}。${e.value.description||""}`})});const n=()=>{v("close")},a=C=>({forge:"锻造所",shop:"商店"})[C]||C,l=$(!1),r=$(!1),h=C=>{C==="forge"?l.value=!0:C==="shop"&&(r.value=!0)},M=()=>{l.value=!1},_=()=>{r.value=!1},g=(C,p=500)=>new Promise(s=>{setTimeout(()=>{b.value.push({id:Date.now(),message:C}),s()},p)}),I=async C=>{if(!d.value){d.value=!0;try{const p=await ee(C.instanceId);if(!p.player.hit)await g(`你的攻击未命中${C.name}`);else{let s=`你对${C.name}造成了${p.player.damage}点伤害`;if(p.player.isCrit&&(s+="（暴击！）"),await g(s),!k.enemyStatus[C.instanceId]){if(await g(`${C.name}被击败了！`),p.drops&&p.drops.length>0){const m=p.drops.map(u=>{for(const L in q.material_types){const R=q.material_types[L];if(R.materials[u])return R.materials[u].name}return u}).join("、");await g(`获得了：${m}`)}K();return}}if(p.enemy)if(!p.enemy.hit)await g(`${C.name}的反击未命中你`);else{let s=`${C.name}反击对你造成了${p.enemy.damage}点伤害`;if(p.enemy.isCrit&&(s+="（暴击！）"),await g(s),!p.enemy.isPlayerAlive){await g("你被击败了，装备材料掉了一地，太可惜了");return}}}catch(p){console.error("Attack failed:",p),await g("你脚下一滑，攻击没有发起")}finally{d.value=!1}}};return H(b,()=>{D(()=>{const C=document.querySelector(".combat-log-content");C&&(C.scrollTop=C.scrollHeight)})},{deep:!0}),(C,p)=>(f(),y("div",null,[t("div",{class:"overlay",onClick:n}),t("div",Ae,[t("div",Oe,[t("div",De,[t("div",Ye,x(e.value.name),1)]),t("div",He,[p[2]||(p[2]=t("div",{class:"section-title"},"探索日志",-1)),t("div",Ke,[(f(!0),y(T,null,N(b.value,s=>(f(),y("div",{key:s.id},x(s.message),1))),128))])]),t("div",We,[t("div",{class:F(["tab-item",{active:i.value==="enemies"}]),onClick:p[0]||(p[0]=s=>i.value="enemies")}," 生物列表 ",2),t("div",{class:F(["tab-item",{active:i.value==="npcs"}]),onClick:p[1]||(p[1]=s=>i.value="npcs")}," NPC列表 ",2)]),i.value==="enemies"?(f(),y("div",Xe,[t("div",ze,[(f(!0),y(T,null,N(c.value,s=>(f(),y("div",{key:s.instanceId,class:"enemy-item"},[t("span",null,x(s.name)+" (HP: "+x(s.hp)+")",1),t("button",{onClick:m=>I(s),disabled:d.value}," 攻击 ",8,Ue)]))),128))])])):S("",!0),i.value==="npcs"&&e.value.npc?(f(),y("div",Ge,[t("div",Je,[(f(!0),y(T,null,N(e.value.npc,(s,m)=>(f(),y("div",{key:m,class:"npc-item",onClick:u=>h(m)},[t("span",null,x(a(m)),1),p[3]||(p[3]=t("i",{class:"icon-arrow-right"},null,-1)),m==="forge"||m==="shop"?(f(),y("button",Ze,"进入")):S("",!0)],8,Qe))),128))])])):S("",!0)])]),l.value?(f(),Y(we,{key:0,class:"npc-view",onClose:M})):S("",!0),r.value?(f(),Y(Pe,{key:1,class:"npc-view",onClose:_})):S("",!0)]))}},tt=A(et,[["__scopeId","data-v-02b0f299"]]),st={class:"map-container"},nt={__name:"MapView",setup(w){const o=$(null),i=$(!1),e=P[k.currentMapId],b=e.locations,d=e.bg_image,c=()=>{const n=o.value,a=n.getContext("2d");a.clearRect(0,0,n.width,n.height);const l=new Image;l.src=d,l.onload=()=>{a.drawImage(l,0,0,n.width,n.height);const r=new Set;Object.values(b).forEach(h=>{const M=h.position.x,_=h.position.y;h.adjacent_locations.forEach(g=>{const I=[h.id,g].sort().join("-");if(!r.has(I)){const E=b[g];E&&(a.beginPath(),a.moveTo(M,_-8),a.lineTo(E.position.x,E.position.y-8),a.strokeStyle="#ffd700",a.lineWidth=2,a.stroke(),r.add(I))}}),a.beginPath(),a.fillStyle=k.currentLocationId===h.id?"#ff0000":"#ffd700",a.font="32px Arial",a.textAlign="center",a.fillText("★",M,_),a.fillStyle="white",a.font="16px Arial",a.textAlign="center",a.fillText(h.name,M,_-30)})}},v=n=>{const l=o.value.getBoundingClientRect(),r=n.clientX-l.left,h=n.clientY-l.top;Object.keys(b).forEach(M=>{const _=b[M],g=_.position.x,I=_.position.y;Math.abs(r-g)<20&&Math.abs(h-I)<20&&(J(M),i.value=!0)})};return X(()=>{const n=o.value;n.width=e.width,n.height=e.height,c(),n.addEventListener("click",v)}),H(()=>k.currentLocationId,c),(n,a)=>(f(),y("div",st,[t("canvas",{ref_key:"mapCanvas",ref:o,class:"map-canvas"},null,512),i.value?(f(),Y(tt,{key:0,onClose:a[0]||(a[0]=l=>i.value=!1)})):S("",!0)]))}},lt=A(nt,[["__scopeId","data-v-b6ca239f"]]);export{lt as default};
